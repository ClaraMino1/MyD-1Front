<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Ventas por ISBN</title>
    <link rel="stylesheet" href="./styles.css">
    <script src="https://kit.fontawesome.com/e99a8b90e3.js" crossorigin="anonymous"></script>
</head>
<body>
    <div class="header-contenedor">
        <div style="display: flex; align-items: center;">
            <input type="text" id="isbn" placeholder="Ingrese ISBN sin guiones" onkeypress="checkEnter(event)">
            <button class="btn-buscar">
                <i class="fa-solid fa-magnifying-glass"></i>
            </button>
        </div>
    </div>

    <div class="filters-container">
        <div>
            <label for="format">Formato:</label>
            <select id="format">
                <option value="">Todos</option>
                <option value="fisico">Físico</option>
                <option value="digital">Digital</option>
            </select>
        </div>
        <div>
            <label for="pais">País:</label>
            <select id="pais">
                <option value="">Todos</option>
                <option value="argentina">Argentina</option>
                <option value="extranjero">Extranjero</option>
            </select>
        </div>
        <div>
            <label for="mesInicio">Mes de consulta:</label>
            <input type="month" id="mesInicio" min="2022-01">
        </div>
        <div class="custom-month-container">
            <span class="optional-label">Opcional</span>
            <label class="custom-month-label">Hasta el mes:</label>
            <input type="month" id="mesFin" min="2022-01" class="custom-month-input">
        </div>
    </div>

    <div id="error-message" style="display: none; color: red; margin-top: 20px;"></div>
    <div id="loading-indicator" style="display: none; text-align: center; margin-top: 20px;">
        <i class="fa-solid fa-spinner fa-spin" style="font-size: 2rem; color: var(--rojo);"></i>
        <p>Cargando...</p>
    </div>

    <table id="data-table" style="display: none;">
        <thead></thead>
        <tbody></tbody>
    </table>

     

    <script>
    async function fetchData() {
    const isbn = document.getElementById('isbn').value.trim();
    const format = document.getElementById('format').value;
    const pais = document.getElementById('pais').value;
    const mesInicioInput = document.getElementById('mesInicio').value;
    const mesFinInput = document.getElementById('mesFin').value;
    const errorMessage = document.getElementById('error-message');
    const table = document.getElementById('data-table');
    const tableBody = table.querySelector('tbody');
    const thead = table.querySelector('thead');
    const loadingIndicator = document.getElementById('loading-indicator');

    errorMessage.style.display = 'none';
    table.style.display = 'none';
    tableBody.innerHTML = '';
    loadingIndicator.style.display = 'block';

    if (!isbn) {
        loadingIndicator.style.display = 'none';
        errorMessage.textContent = 'Por favor, ingresa un ISBN.';
        errorMessage.style.display = 'block';
        return;
    }

    if (mesInicioInput && mesFinInput && mesInicioInput > mesFinInput) {
        loadingIndicator.style.display = 'none';
        errorMessage.textContent = 'El mes de inicio no puede ser posterior al mes de fin.';
        errorMessage.style.display = 'block';
        return;
    }

    try {
        let mesInicio = '';
        let mesFin = '';

        if (mesInicioInput) {
            const [year, month] = mesInicioInput.split('-');
            const meses = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
            mesInicio = `${meses[parseInt(month) - 1]} ${year}`;
        }

        if (mesFinInput) {
            const [year, month] = mesFinInput.split('-');
            const meses = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
            mesFin = `${meses[parseInt(month) - 1]} ${year}`;
        }

        let url = `https://mydback.onrender.com/readExcelByISBN?isbn=${isbn}`;
        if (mesInicio) url += `&mesInicio=${mesInicio}`;
        if (mesFin) url += `&mesFin=${mesFin}`;

        const response = await fetch(url);
        if (!response.ok) throw new Error('No se pudo obtener la información del servidor');

        const data = await response.json();
        if (!data || data.error) {
            errorMessage.textContent = data.error || 'ERROR: El ISBN ingresado no existe.';
            errorMessage.style.display = 'block';
            return;
        }

        let ventas = calcularVentas(data, format, pais, mesInicio, mesFin);

        thead.innerHTML = `<tr><th>Título</th><th>${obtenerEncabezado(format, pais)}</th></tr>`;
        tableBody.innerHTML = `<tr><td>${data.titulo}</td><td>${ventas}</td></tr>`;
        table.style.display = 'table';
    } catch (error) {
        errorMessage.textContent = 'Error al obtener los datos: ' + error.message;
        errorMessage.style.display = 'block';
    } finally {
        loadingIndicator.style.display = 'none';
    }
}

function calcularVentas(data, format, pais, mesInicio, mesFin) {
    let total = 0;
    if (mesInicio && mesFin) {
        // Lógica para rango de meses
        if (format === 'fisico') {
            if (pais === 'argentina') total = data.fisicoArgentina;
            else if (pais === 'extranjero') total = data.fisicoExtranjero;
            else total = data.fisicoArgentina + data.fisicoExtranjero;
        } else if (format === 'digital') {
            if (pais === 'argentina') total = data.digitalArgentina;
            else if (pais === 'extranjero') total = data.digitalExtranjero;
            else total = data.digitalArgentina + data.digitalExtranjero;
        } else {
            if (pais === 'argentina') total = data.fisicoArgentina + data.digitalArgentina;
            else if (pais === 'extranjero') total = data.fisicoExtranjero + data.digitalExtranjero;
            else total = data.fisicoArgentina + data.fisicoExtranjero + data.digitalArgentina + data.digitalExtranjero;
        }
    } else if (mesInicio) {
        // Lógica para un mes específico
        if (format === 'fisico') {
            if (pais === 'argentina') total = data.fisicoArgentina;
            else if (pais === 'extranjero') total = data.fisicoExtranjero;
            else total = data.fisicoArgentina + data.fisicoExtranjero;
        } else if (format === 'digital') {
            if (pais === 'argentina') total = data.digitalArgentina;
            else if (pais === 'extranjero') total = data.digitalExtranjero;
            else total = data.digitalArgentina + data.digitalExtranjero;
        } else {
            if (pais === 'argentina') total = data.fisicoArgentina + data.digitalArgentina;
            else if (pais === 'extranjero') total = data.fisicoExtranjero + data.digitalExtranjero;
            else total = data.fisicoArgentina + data.fisicoExtranjero + data.digitalArgentina + data.digitalExtranjero;
        }
    } else {
        // Lógica para todos los meses
        if (format === 'fisico') {
            if (pais === 'argentina') total = data.fisicoArgentina;
            else if (pais === 'extranjero') total = data.fisicoExtranjero;
            else total = data.fisicoArgentina + data.fisicoExtranjero;
        } else if (format === 'digital') {
            if (pais === 'argentina') total = data.digitalArgentina;
            else if (pais === 'extranjero') total = data.digitalExtranjero;
            else total = data.digitalArgentina + data.digitalExtranjero;
        } else {
            if (pais === 'argentina') total = data.fisicoArgentina + data.digitalArgentina;
            else if (pais === 'extranjero') total = data.fisicoExtranjero + data.digitalExtranjero;
            else total = data.fisicoArgentina + data.fisicoExtranjero + data.digitalArgentina + data.digitalExtranjero;
        }
    }
    return total;
}

function obtenerEncabezado(format, pais) {
    if (format === 'fisico') {
        return pais === 'argentina' ? 'Ventas Físicas Argentinas' : pais === 'extranjero' ? 'Ventas Físicas Extranjeras' : 'Ventas Físicas';
    } else if (format === 'digital') {
        return pais === 'argentina' ? 'Ventas Digitales Argentinas' : pais === 'extranjero' ? 'Ventas Digitales Extranjeras' : 'Ventas Digitales';
    } else {
        return pais === 'argentina' ? 'Ventas Totales Argentinas' : pais === 'extranjero' ? 'Ventas Totales Extranjeras' : 'Ventas Totales';
    }
}

function checkEnter(event) {
    if (event.key === 'Enter') fetchData();
}

document.addEventListener('DOMContentLoaded', function() {
    document.querySelector('.btn-buscar').addEventListener('click', fetchData);
    document.getElementById('mesInicio').addEventListener('change', fetchData);
    document.getElementById('mesFin').addEventListener('change', fetchData);
    document.getElementById('format').addEventListener('change', fetchData);
    document.getElementById('pais').addEventListener('change', fetchData);
});
    </script>
</body>
</html>
