<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Ventas por ISBN</title>
    <link rel="stylesheet" href="./styles.css">
    <script src="https://kit.fontawesome.com/e99a8b90e3.js" crossorigin="anonymous"></script>
</head>
<body>
    <div class="header-contenedor">
        <div style="display: flex; align-items: center;">
            <input type="text" id="isbn" placeholder="Ingrese ISBN sin guiones" onkeypress="checkEnter(event)">
            <button class="btn-buscar">
                <i class="fa-solid fa-magnifying-glass"></i>
            </button>
        </div>
    </div>

    <div class="filters-container">
        <div>
            <label for="format">Formato:</label>
            <select id="format">
                <option value="">Todos</option>
                <option value="fisico">Físico</option>
                <option value="digital">Digital</option>
            </select>
        </div>
        <div>
            <label for="pais">País:</label>
            <select id="pais">
                <option value="">Todos</option>
                <option value="argentina">Argentina</option>
                <option value="extranjero">Extranjero</option>
            </select>
        </div>
        <div>
            <label for="mes">Mes:</label>
            <input type="month" id="mes" min="2022-01">
        </div>
    </div>

    <div id="error-message" style="display: none; color: red; margin-top: 20px;"></div>
    <div id="loading-indicator" style="display: none; text-align: center; margin-top: 20px;">
        <i class="fa-solid fa-spinner fa-spin" style="font-size: 2rem; color: var(--rojo);"></i>
        <p>Cargando...</p>
    </div>

    <table id="data-table" style="display: none;">
        <thead></thead>
        <tbody></tbody>
    </table>

    <script>
        async function fetchData() {
            const isbn = document.getElementById('isbn').value.trim();
            const format = document.getElementById('format').value;
            const pais = document.getElementById('pais').value;
            const mesInput = document.getElementById('mes').value;
            const errorMessage = document.getElementById('error-message');
            const table = document.getElementById('data-table');
            const tableBody = table.querySelector('tbody');
            const thead = table.querySelector('thead');
            const loadingIndicator = document.getElementById('loading-indicator');

            errorMessage.style.display = 'none';
            table.style.display = 'none';
            tableBody.innerHTML = '';
            loadingIndicator.style.display = 'block'; // Muestra el indicador de cargando

            if (!isbn) {
                loadingIndicator.style.display = 'none'; // Oculta el indicador si hay error
                errorMessage.textContent = 'Por favor, ingresa un ISBN.';
                errorMessage.style.display = 'block';
                return;
            }

            try {
                let mes = '';
                if (mesInput) {
                    const [year, month] = mesInput.split('-');
                    const meses = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
                    mes = `${meses[parseInt(month) - 1]} ${year}`;
                }

                const response = await fetch(`https://mydback.onrender.com/readExcelByISBN?isbn=${isbn}&mes=${mes}`);
                if (!response.ok) throw new Error('No se pudo obtener la información del servidor');

                const data = await response.json();
                if (!data || data.error) {
                    errorMessage.textContent = data.error || 'ERROR: El ISBN ingresado no existe.';
                    errorMessage.style.display = 'block';
                    return;
                }

                let ventas = calcularVentas(data, format, pais, mes);

                thead.innerHTML = `<tr><th>Título</th><th>${obtenerEncabezado(format, pais)}</th></tr>`;
                tableBody.innerHTML = `<tr><td>${data.titulo}</td><td>${ventas}</td></tr>`;
                table.style.display = 'table';
            } catch (error) {
                errorMessage.textContent = 'Error al obtener los datos: ' + error.message;
                errorMessage.style.display = 'block';
            } finally {
                loadingIndicator.style.display = 'none'; // Oculta el indicador al terminar
            }
        }

        function calcularVentas(data, format, pais, mes) {
    let total = 0;

    if (mes) {
        // Si se selecciona un mes, usa las ventas específicas del mes
        const fisicoArgentina = data.fisicoArgentina || 0;
        const fisicoExtranjero = data.fisicoExtranjero || 0;
        const digitalArgentina = data.digitalArgentina || 0;
        const digitalExtranjero = data.digitalExtranjero || 0;

        if (format === 'fisico') {
            if (pais === 'argentina') total = fisicoArgentina;
            else if (pais === 'extranjero') total = fisicoExtranjero;
            else total = fisicoArgentina + fisicoExtranjero;
        } else if (format === 'digital') {
            if (pais === 'argentina') total = digitalArgentina;
            else if (pais === 'extranjero') total = digitalExtranjero;
            else total = digitalArgentina + digitalExtranjero;
        } else {
            if (pais === 'argentina') total = fisicoArgentina + digitalArgentina;
            else if (pais === 'extranjero') total = fisicoExtranjero + digitalExtranjero;
            else total = fisicoArgentina + fisicoExtranjero + digitalArgentina + digitalExtranjero;
        }
    } else {
        // Si no se selecciona un mes, usa las ventas totales
        if (format === 'fisico') {
            if (pais === 'argentina') total = data.ventasPorMes.reduce((sum, item) => sum + parseInt(item.cantidadF || 0), 0);
            else if (pais === 'extranjero') total = data.fisicoExtranjero; // Ajusta esto si tienes ventas físicas extranjeras por mes
            else total = data.ventasPorMes.reduce((sum, item) => sum + parseInt(item.cantidadF || 0), 0) + (data.fisicoExtranjero || 0); // Ajusta esto si tienes ventas físicas extranjeras por mes
        } else if (format === 'digital') {
            if (pais === 'argentina') total = data.ventasPorMes.reduce((sum, item) => sum + parseInt(item.ventasDigitales || 0), 0);
            else if (pais === 'extranjero') total = data.digitalExtranjero; // Ajusta esto si tienes ventas digitales extranjeras por mes
            else total = data.ventasPorMes.reduce((sum, item) => sum + parseInt(item.ventasDigitales || 0), 0) + (data.digitalExtranjero || 0); // Ajusta esto si tienes ventas digitales extranjeras por mes
        } else {
            if (pais === 'argentina') total = data.ventasPorMes.reduce((sum, item) => sum + parseInt(item.ventasTotales || 0), 0);
            else if (pais === 'extranjero') total = (data.fisicoExtranjero || 0) + (data.digitalExtranjero || 0);
            else total = data.ventasPorMes.reduce((sum, item) => sum + parseInt(item.ventasTotales || 0), 0) + (data.fisicoExtranjero || 0) + (data.digitalExtranjero || 0);
        }
    }

    return total;
}

        function obtenerEncabezado(format, pais) {
            if (format === 'fisico') {
                return pais === 'argentina' ? 'Ventas Físicas Argentinas' : pais === 'extranjero' ? 'Ventas Físicas Extranjeras' : 'Ventas Físicas';
            } else if (format === 'digital') {
                return pais === 'argentina' ? 'Ventas Digitales Argentinas' : pais === 'extranjero' ? 'Ventas Digitales Extranjeras' : 'Ventas Digitales';
            } else {
                return pais === 'argentina' ? 'Ventas Totales Argentinas' : pais === 'extranjero' ? 'Ventas Totales Extranjeras' : 'Ventas Totales';
            }
        }

        function checkEnter(event) {
            if (event.key === 'Enter') fetchData();
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.querySelector('.btn-buscar').addEventListener('click', fetchData);
            document.getElementById('mes').addEventListener('change', fetchData);
            document.getElementById('format').addEventListener('change', fetchData);
            document.getElementById('pais').addEventListener('change', fetchData);
        });
    </script>
</body>
</html>
