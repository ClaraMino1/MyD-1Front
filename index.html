<!DOCTYPE html> 
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consulta de Ventas por ISBN</title>
  <script src="./index.js"></script>
  <link rel="stylesheet" href="./styles.css">
  <script src="https://kit.fontawesome.com/e99a8b90e3.js" crossorigin="anonymous"></script>
</head>
<body>
  <div class="header-contenedor">
    <div class="buscador-container">
      <input type="text" id="isbn" placeholder="Ingrese ISBN sin guiones" onkeypress="checkEnter(event)">
      <button class="btn-buscar" onclick="fetchData()">
        <i class="fa-solid fa-magnifying-glass"></i>
      </button>
    </div>
  </div>

  <!-- Filtros -->
  <div class="filters-container">
    <div>
      <label for="format">Formato:</label>
      <select id="format">
        <option value="">Todos</option>
        <option value="fisico">Físico</option>
        <option value="digital">Digital</option>
      </select>
    </div>

   <!-- <div>
      <label for="month">Mes:</label>
      <select id="month">
        <option value="todos">Todos</option>
        <option value="1">Enero</option>
        <option value="2">Febrero</option>
        <option value="3">Marzo</option>
        <option value="4">Abril</option>
        <option value="5">Mayo</option>
        <option value="6">Junio</option>
        <option value="7">Julio</option>
        <option value="8">Agosto</option>
        <option value="9">Septiembre</option>
        <option value="10">Octubre</option>
        <option value="11">Noviembre</option>
        <option value="12">Diciembre</option>
      </select>
    </div>

    <div>
      <label for="year">Año:</label>
      <select id="year">
        <option value="todos">Todos</option>
        <option value="2024">2024</option>
        <option value="2025">2025</option>
      </select>
    </div>

    <div>
      <label for="country">País:</label>
      <select id="country">
        <option value="">Todos</option>
        <option value="argentina">Argentina</option>
        <option value="otros">Otros</option>
      </select>
    </div>

    <div>
      <label for="startMonth">Desde Mes:</label>
      <select id="startMonth">
        <option value="">Seleccionar</option>
        <option value="1">Enero</option>
        <option value="2">Febrero</option>
        <option value="3">Marzo</option>
        <option value="4">Abril</option>
        <option value="5">Mayo</option>
        <option value="6">Junio</option>
        <option value="7">Julio</option>
        <option value="8">Agosto</option>
        <option value="9">Septiembre</option>
        <option value="10">Octubre</option>
        <option value="11">Noviembre</option>
        <option value="12">Diciembre</option>
      </select>
    </div>

    <div>
      <label for="endMonth">Hasta Mes:</label>
      <select id="endMonth">
        <option value="">Seleccionar</option>
        <option value="1">Enero</option>
        <option value="2">Febrero</option>
        <option value="3">Marzo</option>
        <option value="4">Abril</option>
        <option value="5">Mayo</option>
        <option value="6">Junio</option>
        <option value="7">Julio</option>
        <option value="8">Agosto</option>
        <option value="9">Septiembre</option>
        <option value="10">Octubre</option>
        <option value="11">Noviembre</option>
        <option value="12">Diciembre</option>
      </select>
    </div>
    -->
  </div>

  <div id="loadingMessage" style="display: none; margin-top: 20px;">
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%;">
      <i class="fa-solid fa-spinner fa-spin-pulse"></i>
      <p id="loading" style="display: none;">Cargando...</p>
    </div>
  </div>

  <div id="error-message" style="display: none; color: red; margin-top: 20px; font-family: system-ui;"></div>

  <table id="data-table" style="display: none;">
    <tbody></tbody>
  </table>

  <script>
    async function fetchData() {
      const isbn = document.getElementById('isbn').value.trim();
      const format = document.getElementById('format').value.toLowerCase();
      const month = document.getElementById('month').value;
      const year = document.getElementById('year').value;
      const country = document.getElementById('country').value;
      const startMonth = document.getElementById('startMonth').value;
      const endMonth = document.getElementById('endMonth').value;
      const errorMessage = document.getElementById('error-message');
      const loadingElement = document.getElementById('loading');
      const loadingMessage = document.getElementById('loadingMessage');
      const table = document.getElementById('data-table');
      const tableBody = document.querySelector('#data-table tbody');
      
      errorMessage.style.display = 'none';
      errorMessage.textContent = '';
      table.style.display = 'none';
      tableBody.innerHTML = '';

      if (!isbn) {
        errorMessage.textContent = 'Por favor, ingresa un ISBN.';
        errorMessage.style.display = 'block';
        return;
      }
      
      loadingMessage.style.display = 'block';
      loadingElement.style.display = 'block';
      
      try {
        // Construir la URL con los filtros
        let url = `https://myd-back-copia.onrender.com/readExcelByISBN?isbn=${isbn}&format=${format}`;

        if (month) url += `&month=${month}`;
        if (year) url += `&year=${year}`;
        if (country) url += `&country=${country}`;
        if (startMonth && endMonth) url += `&startMonth=${startMonth}&endMonth=${endMonth}`;

        const response = await fetch(url);
        if (!response.ok) {
          throw new Error('No se pudo obtener la información del servidor');
        }
        const data = await response.json();
        if (!data || !data.titulo) {
          errorMessage.textContent = 'ERROR: El ISBN ingresado no existe o no hay datos para el formato seleccionado.';
          errorMessage.style.display = 'block';
          return;
        }
        
        // Construir la cabecera y la fila de acuerdo al formato seleccionado
        let headerHTML = '';
        let rowHTML = '';
        if (format === 'fisico') {
          headerHTML = `
            <thead>
              <tr>
                <th>Título</th>
                <th>Ventas Físicas</th>
              </tr>
            </thead>
          `;
          rowHTML = `<tr><td>${data.titulo}</td><td>${data.ventasFisicas}</td></tr>`;
        } else if (format === 'digital') {
          headerHTML = `
            <thead>
              <tr>
                <th>Título</th>
                <th>Ventas Digitales</th>
              </tr>
            </thead>
          `;
          rowHTML = `<tr><td>${data.titulo}</td><td>${data.ventasDigitales}</td></tr>`;
        } else {
          headerHTML = `
            <thead>
              <tr>
                <th>Título</th>
                <th>Ventas Totales</th>
                <th>Ventas Físicas</th>
                <th>Ventas Digitales</th>
              </tr>
            </thead>
          `;
          rowHTML = `<tr>
            <td>${data.titulo}</td>
            <td>${data.ventasTotales}</td>
            <td>${data.ventasFisicas}</td>
            <td>${data.ventasDigitales}</td>
          </tr>`;
        }
        
        table.innerHTML = headerHTML + `<tbody>${rowHTML}</tbody>`;
        table.style.display = 'table';
      } catch (error) {
        console.error('Error:', error);
        errorMessage.textContent = 'Error al obtener los datos: ' + error.message;
        errorMessage.style.display = 'block';
      } finally {
        loadingMessage.style.display = 'none';
        loadingElement.style.display = 'none';
      }
    }
    
    function checkEnter(event) {
      if (event.keyCode === 13) {
        fetchData();
      }
    }
  </script>
</body>
</html>
